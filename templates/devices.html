{% extends "base.html" %}

{% block title %}Устройства - Cisco Configuration Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="fas fa-server me-2"></i>
                    Управление устройствами
                </h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                    <i class="fas fa-plus me-2"></i>Добавить устройство
                </button>
            </div>
        </div>
    </div>

    <!-- Devices Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    {% if devices %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="devicesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Название</th>
                                    <th>IP адрес</th>
                                    <th>Тип устройства</th>
                                    <th>Статус</th>
                                    <th>Последнее подключение</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in devices %}
                                <tr id="device-{{ device.id }}">
                                    <td>
                                        <strong>{{ device.name }}</strong>
                                    </td>
                                    <td>{{ device.ip }}:{{ device.port or 22 }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ device.device_type }}</span>
                                    </td>
                                    <td class="status-cell">
                                        {% if device.status == 'connected' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>Подключено
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-times-circle me-1"></i>Отключено
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device.last_connected %}
                                            <small class="text-muted">
                                                {{ device.last_connected[:19].replace('T', ' ') }}
                                            </small>
                                        {% else %}
                                            <small class="text-muted">Никогда</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="connectDevice('{{ device.id }}')" 
                                                    title="Подключиться">
                                                <i class="fas fa-plug"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" 
                                                    onclick="getDeviceStatus('{{ device.id }}')" 
                                                    title="Статус">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <a href="{{ url_for('configure_device', device_id=device.id) }}" 
                                               class="btn btn-sm btn-outline-success" 
                                               title="Настроить">
                                                <i class="fas fa-cog"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-warning" 
                                                    onclick="showCommandModal('{{ device.id }}')" 
                                                    title="Команды">
                                                <i class="fas fa-terminal"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteDevice('{{ device.id }}')" 
                                                    title="Удалить">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-server fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Устройства не найдены</h4>
                        <p class="text-muted">Добавьте первое устройство для начала работы</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                            <i class="fas fa-plus me-2"></i>Добавить устройство
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Добавить устройство
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addDeviceForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="deviceName" class="form-label">Название устройства</label>
                        <input type="text" class="form-control" id="deviceName" required>
                    </div>
                    <div class="mb-3">
                        <label for="deviceIp" class="form-label">IP адрес</label>
                        <input type="text" class="form-control" id="deviceIp" 
                               pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="deviceType" class="form-label">Тип устройства</label>
                                <select class="form-select" id="deviceType">
                                    <option value="cisco_ios">Cisco IOS</option>
                                    <option value="cisco_ios_xe">Cisco IOS XE</option>
                                    <option value="cisco_nxos">Cisco NX-OS</option>
                                    <option value="cisco_asa">Cisco ASA</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="devicePort" class="form-label">Порт</label>
                                <input type="number" class="form-control" id="devicePort" value="22" min="1" max="65535">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="deviceUsername" class="form-label">Имя пользователя</label>
                        <input type="text" class="form-control" id="deviceUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="devicePassword" class="form-label">Пароль</label>
                        <input type="password" class="form-control" id="devicePassword" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="testConnection">
                        <label class="form-check-label" for="testConnection">
                            Проверить подключение при добавлении
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Добавить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Command Modal -->
<div class="modal fade" id="commandModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-terminal me-2"></i>Выполнить команду
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="commandForm">
                    <div class="mb-3">
                        <label for="command" class="form-label">Команда</label>
                        <input type="text" class="form-control" id="command" 
                               placeholder="show version" required>
                    </div>
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>Выполнить
                        </button>
                    </div>
                </form>
                <div id="commandOutput" class="mt-3" style="display: none;">
                    <label class="form-label">Результат:</label>
                    <pre class="bg-dark text-light p-3 rounded" id="outputContent"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Статус устройства
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="statusContent">
                    <!-- Динамический контент -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <div class="mt-3">Выполняется операция...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentDeviceId = null;

// Добавление устройства
document.getElementById('addDeviceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const deviceData = {
        name: document.getElementById('deviceName').value,
        ip: document.getElementById('deviceIp').value,
        username: document.getElementById('deviceUsername').value,
        password: document.getElementById('devicePassword').value,
        device_type: document.getElementById('deviceType').value,
        port: parseInt(document.getElementById('devicePort').value)
    };
    
    $('#loadingModal').modal('show');
    
    fetch('/api/devices', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(deviceData)
    })
    .then(response => response.json())
    .then(data => {
        $('#loadingModal').modal('hide');
        if (data.success) {
            $('#addDeviceModal').modal('hide');
            
            // Проверить подключение если выбрано
            if (document.getElementById('testConnection').checked) {
                connectDevice(data.device_id);
            } else {
                showAlert('Устройство успешно добавлено', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showAlert('Ошибка добавления: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        $('#loadingModal').modal('hide');
        showAlert('Ошибка сети: ' + error.message, 'danger');
    });
});

// Подключение к устройству
function connectDevice(deviceId) {
    $('#loadingModal').modal('show');
    
    fetch(`/api/devices/${deviceId}/connect`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        $('#loadingModal').modal('hide');
        if (data.success) {
            showAlert('Подключение успешно установлено', 'success');
            updateDeviceStatus(deviceId, 'connected');
        } else {
            showAlert('Ошибка подключения: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        $('#loadingModal').modal('hide');
        showAlert('Ошибка сети: ' + error.message, 'danger');
    });
}

// Получение статуса устройства
function getDeviceStatus(deviceId) {
    $('#loadingModal').modal('show');
    
    fetch(`/api/devices/${deviceId}/status`)
    .then(response => response.json())
    .then(data => {
        $('#loadingModal').modal('hide');
        if (data.success) {
            showDeviceStatus(data.status);
        } else {
            showAlert('Ошибка получения статуса: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        $('#loadingModal').modal('hide');
        showAlert('Ошибка сети: ' + error.message, 'danger');
    });
}

// Показать статус устройства
function showDeviceStatus(status) {
    const statusContent = document.getElementById('statusContent');
    const connectedStatus = status.connected ? 
        '<span class="badge bg-success">Подключено</span>' : 
        '<span class="badge bg-secondary">Отключено</span>';
    
    let content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Основная информация</h6>
                <p><strong>Название:</strong> ${status.device_info.name}</p>
                <p><strong>IP:</strong> ${status.device_info.ip}</p>
                <p><strong>Статус:</strong> ${connectedStatus}</p>
                <p><strong>Последнее подключение:</strong> ${status.last_connected || 'Никогда'}</p>
            </div>
        </div>
    `;
    
    if (status.uptime) {
        content += `
            <hr>
            <h6>Информация о системе</h6>
            <pre class="bg-light p-2 rounded">${status.uptime}</pre>
        `;
    }
    
    if (status.interfaces) {
        content += `
            <hr>
            <h6>Интерфейсы</h6>
            <pre class="bg-light p-2 rounded">${status.interfaces}</pre>
        `;
    }
    
    statusContent.innerHTML = content;
    $('#statusModal').modal('show');
}

// Показать модальное окно команд
function showCommandModal(deviceId) {
    currentDeviceId = deviceId;
    document.getElementById('command').value = '';
    document.getElementById('commandOutput').style.display = 'none';
    $('#commandModal').modal('show');
}

// Выполнение команды
document.getElementById('commandForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const command = document.getElementById('command').value;
    if (!command || !currentDeviceId) return;
    
    $('#loadingModal').modal('show');
    
    fetch(`/api/devices/${currentDeviceId}/command`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ command: command })
    })
    .then(response => response.json())
    .then(data => {
        $('#loadingModal').modal('hide');
        if (data.success) {
            document.getElementById('outputContent').textContent = data.output;
            document.getElementById('commandOutput').style.display = 'block';
        } else {
            showAlert('Ошибка выполнения команды: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        $('#loadingModal').modal('hide');
        showAlert('Ошибка сети: ' + error.message, 'danger');
    });
});

// Удаление устройства
function deleteDevice(deviceId) {
    if (confirm('Вы уверены, что хотите удалить это устройство? Это действие нельзя отменить.')) {
        $('#loadingModal').modal('show');
        
        fetch(`/api/devices/${deviceId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            $('#loadingModal').modal('hide');
            if (data.success) {
                showAlert('Устройство успешно удалено', 'success');
                // Удаляем строку из таблицы
                const row = document.getElementById(`device-${deviceId}`);
                if (row) {
                    row.remove();
                }
                // Проверяем, остались ли устройства
                const tbody = document.querySelector('#devicesTable tbody');
                if (tbody && tbody.children.length === 0) {
                    setTimeout(() => location.reload(), 1000);
                }
            } else {
                showAlert('Ошибка удаления: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            $('#loadingModal').modal('hide');
            showAlert('Ошибка сети: ' + error.message, 'danger');
        });
    }
}

// Обновление статуса устройства в таблице
function updateDeviceStatus(deviceId, status) {
    const row = document.getElementById(`device-${deviceId}`);
    if (row) {
        const statusCell = row.querySelector('.status-cell');
        if (status === 'connected') {
            statusCell.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Подключено</span>';
        } else {
            statusCell.innerHTML = '<span class="badge bg-secondary"><i class="fas fa-times-circle me-1"></i>Отключено</span>';
        }
    }
}

// Показать уведомление
function showAlert(message, type) {
    const alertDiv = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.container-fluid').first().prepend(alertDiv);
}
</script>
{% endblock %}
